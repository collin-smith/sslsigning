name: CodeSign Demonstration  

# Trigger this workflow on a push
on: [push]

# Environment Variables for configuration
env:
  # Binary file location in the Github repository
  INPUT_FOLDER: input
  INPUT_FILENAME: esbuild.exe
  # The base output folder in the Github repository
  OUTPUT_FOLDER: output

# Defines a single job named "build-and-sign-jar"  
jobs:
  build-and-sign-jar:
    # Run job on Ubuntu Runner
    runs-on: ubuntu-latest
    # When the workflow runs, this is the name that is logged
    name: CodeSigner on Java with Maven
    steps:
      # 1) Check out the source code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2) Sign the file with CodeSignTool
      - name: Sign Artifact with CodeSignTool
        uses: sslcom/esigner-codesign@develop
        with:
          command: sign
          username: ${{ secrets.username }}
          password: ${{ secrets.password }}
          credential_id: ${{ secrets.credential_id }}
          totp_secret: ${{ secrets.totp_secret }}
          file_path: ${{ env.INPUT_FOLDER }}/${{ env.INPUT_FILENAME }}
          output_path: ${{ env.OUTPUT_FOLDER }}
          malware_block: false
          environment_name: TEST

      # 3) Upload artifacts to GitHub Actions
      - name: Upload Signed File
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.INPUT_FILENAME }}
          path: ${{ env.OUTPUT_FOLDER }}/${{ env.INPUT_FILENAME }}

      # 4 & 5) Consolidated: Generate Timestamp and Full Path
      - name: Generate Build Metadata
        id: metadata
        run: |
          TS=$(date +'%Y%m%d_%H%M%S')
          echo "TIMESTAMP=$TS" >> $GITHUB_ENV
          echo "FILEPATH=${{ env.OUTPUT_FOLDER }}/$TS" >> $GITHUB_ENV

      # 6) Commit and push the signed file in a timestamped subfolder
      - name: Commit and Push Signed Artifact
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create the subfolder path
          mkdir -p ${{ env.FILEPATH }}
          
          # Move or Copy the signed file into that subfolder
          cp ${{ env.OUTPUT_FOLDER }}/${{ env.INPUT_FILENAME }} ${{ env.FILEPATH }}/${{ env.INPUT_FILENAME }}
          
          # Add the new folder and push
          git add ${{ env.FILEPATH }}/${{ env.INPUT_FILENAME }}
          git commit -m "docs: add signed artifact in folder ${{ env.TIMESTAMP }} [skip ci]"
          git push

      # 7) Upload the signed file to S3
      - name: Upload to S3 
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
        run: |
          aws s3 cp ${{ env.FILEPATH }}/${{ env.INPUT_FILENAME }} \
            s3://${{ secrets.S3_BUCKET_NAME }}/signed-builds/${{ env.TIMESTAMP }}/${{ env.INPUT_FILENAME }}

      # 8) Invalidate CloudFront so the new file is available immediately
      - name: Invalidate CloudFront
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id E2Z6BQTS2F0YM7 \
            --paths "/signed-builds/${{ env.TIMESTAMP }}/*"