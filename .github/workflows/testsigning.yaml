name: CodeSign Demonstration

# Trigger this workflow on a push
on: [push]

# Environment Variables for configuration
env:
  INPUT_FOLDER: input
  INPUT_FILENAME: esbuild.exe
  OUTPUT_FOLDER: output

# Defines a single job named "build-and-sign-jar"  
jobs:
  build-and-sign-jar:
    # Run job on Ubuntu Runner
    runs-on: ubuntu-latest
    # When the workflow runs, this is the name that is logged
    name: CodeSigner on Java with Maven
    steps:
      # 1) Check out the source code so that the workflow can access to the unsigned file
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2) This is the step where the file(See file_path) will be signed with CodeSignTool and exported
      - name: Sign Artifact with CodeSignTool
        uses: sslcom/esigner-codesign@develop
        with:
          # Sign and timestamp code object.
          command: sign
          # SSL.com account username
          username: esigner_demo
          # SSL.com account password.
          password: esignerDemo#1
          # Credential ID for signing certificate.
          credential_id: 8b072e22-7685-4771-b5c6-48e46614915f
          # OAuth TOTP Secret (https://www.ssl.com/how-to/automate-esigner-ev-code-signing)
          totp_secret: RDXYgV9qju+6/7GnMf1vCbKexXVJmUVr+86Wq/8aIGg=
          # Path of code object to be signed. (DLL, JAR, EXE, MSI files vb... )
          file_path: ${{env.INPUT_FOLDER}}/${{env.INPUT_FILENAME}}
          # Directory where signed code object(s) will be written.
          output_path: ${{env.OUTPUT_FOLDER}}
          # Scan code before sign
          malware_block: false
          # Environment Name, For Production 'PROD' or For Staging 'TEST'
          environment_name: TEST

      # 3) This uploads artifacts from your GitHub action allowing you to share data between jobs and store data once a workflow is complete
      - name: Upload Signed File
        uses: actions/upload-artifact@v4
        with:
          name: ${{env.INPUT_FILENAME}}
          path: ${{env.OUTPUT_FOLDER}}/${{env.INPUT_FILENAME}}

    # 4) Generate Timestamp
      - name: Get current date
        id: date
        run: echo "TIMESTAMP=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV

      # 5) Commit the signed file in a timestamped subfolder
      #Note: on this step you will have to give your Actions Read and Write permissions
      #In your github repository, go to settings, Actions/General, update Workflow permissions to be Read and Write Permissions and save
      - name: Commit and Push Signed Artifact
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 1. Create the subfolder path: output/20260204_205957/
          mkdir -p ${{env.OUTPUT_FOLDER}}/${{env.TIMESTAMP}}
          
          # 2. Move or Copy the signed file into that subfolder
          cp ${{env.OUTPUT_FOLDER}}/${{env.INPUT_FILENAME}} ${{env.OUTPUT_FOLDER}}/${{env.TIMESTAMP}}/${{env.INPUT_FILENAME}}
          
          # 3. Add the new folder and push
          git add ${{env.OUTPUT_FOLDER}}/${{env.TIMESTAMP}}/${{env.INPUT_FILENAME}}
          git commit -m "docs: add signed artifact in folder ${{env.TIMESTAMP}} [skip ci]"
          git push